wavm-aot-generator
==================

This project generates a runtime environment for native code generated by [WAVM](https://github.com/WAVM/WAVM). See [this issue](https://github.com/WAVM/WAVM/issues/248) for more details.

Right now the provided WASI runtime is slightly tailored for [Nervos CKB](https://github.com/nervosnetwork/ckb), but you are free to use your own runtime.

How to build a very simple example for CKB VM:
==============================================

```
$ export TOP=$(pwd)
$ git clone https://github.com/xxuejie/WAVM
$ cd WAVM
$ mkdir -p build
$ cd bulid
# Since we will generate RISC-V code, LLVM 9+ is needed
$ cmake .. -DLLVM_DIR=/usr/lib/llvm-9/lib/cmake/llvm
$ make
$ ./bin/wavm compile --target-triple riscv64 --format=precompiled-wasm ../Examples/helloworld.wast helloworld.precompiled.riscv64.wasm

$ cd $TOP
$ git clone https://github.com/xxuejie/ckb-binary-patcher
$ cd ckb-binary-patcher
$ cargo build --release

$ cd $TOP
$ git clone --reursive https://github.com/nervosnetwork/ckb-c-stdlib

$ cd $TOP
$ git clone https://github.com/xxuejie/wavm-aot-generator
$ cd wavm-aot-generator
$ cargo build --release
$ ./target/release/wavm-aot-generator ../WAVM/build/helloworld.precompiled.riscv64.wasm helloworld_riscv
$ cat << EOF > dummy.c
#include "helloworld_riscv_glue.h"
#include "abi/ckb_vm_wasi_abi.h"
EOF
$ riscv64-unknown-elf-gcc -g -o helloworld.riscv64 helloworld_riscv.o dummy.c -I $TOP/ckb-c-stdlib
$ ../ckb-binary/patcher/target/release/ckb-binary-patcher -i helloworld.riscv64 -o helloworld.patched.riscv64
```

`helloworld.patched.riscv64` will then be a CKB VM compatible script that is compiled from WASM.
